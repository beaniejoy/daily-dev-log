> - 200509 dev log
> - cagong-ranking-project  
> - spring-boot, MySQL, IntelliJ  

<br>

## ğŸ”– 1. íšŒì›ê°€ì… ë•Œ ajax

`POST /users` request ì²˜ë¦¬  


```js
var params = "account=" + $("#account").val() +
            "&email=" + $("#email").val() +
            "&phoneNumber=" + $("#phone").val() +
            "&password=" + $("#password").val();

$.ajax({
        type: 'POST',
        url: 'users',
        data: params,
        dataType: 'text',
        success: function (data) {
            var result = Number(data);
            switch (result) {
                case 0:
                    alert("ì„±ê³µì ìœ¼ë¡œ íšŒì›ê°€ì…ì´ ë˜ì—ˆìŠµë‹ˆë‹¤.");
                    location.href = "/login";
                    break;
                case 1:
                    alert("ì´ì „ì— ë“±ë¡ëœ ì´ë©”ì¼ì´ ì¡´ì¬í•©ë‹ˆë‹¤.");
                    $("#email").addClass("is-invalid");
                    $("#emailMessage").html("<span class='text-danger'>ì´ì „ì— ë“±ë¡ëœ ì´ë©”ì¼ì´ ì¡´ì¬í•©ë‹ˆë‹¤.</span>");
                    break;
                default:
                    alert("íšŒì›ê°€ì…ì— ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì§„í–‰í•´ì£¼ì„¸ìš”.");
                    break;
            }
        },
        error: function(error) {
            alert("ì˜¤ë¥˜ ë°œìƒ " + error);
        }
    })
```
- íšŒì›ê°€ì… ë•Œ ì„±ê³µ ìœ ë¬´ë¥¼ ajaxë¥¼ í†µí•´ alert ê²½ê³ ì°½ìœ¼ë¡œ ì•Œë¦¬ë„ë¡ í–ˆë‹¤.
- contentTypeìœ¼ë¡œ `application/json`ìœ¼ë¡œ ë”°ë¡œ ì„¤ì •í•˜ì§€ ì•Šì•˜ê¸°ì— ê¸°ë³¸ê°’ìœ¼ë¡œ `application/x-www-form-urlencoded`

<br>

```java
// UserService.java
    public UserApiResponse registerUser(UserApiRequest resource) {

        Optional<User> existed = userRepository.findByEmail(resource.getEmail());

        if (existed.isPresent()) {
            throw new EmailExistedException(resource.getEmail());
        }

        String encodedPassword = passwordEncoder.encode(resource.getPassword());

        User user = User.builder()
                .account(resource.getAccount())
                .email(resource.getEmail())
                .phoneNumber(resource.getPhoneNumber())
                .password(encodedPassword)
                .build();

        User saved = userRepository.save(user);

        return response(saved);
    }
```
- íšŒì›ê°€ì… ë•Œ ìš°ì„  Emailì„ ê¸°ì¤€ìœ¼ë¡œ DBì— ê¸°ì¡´ì— ì €ì¥ëœ ë°ì´í„°ê°€ ìˆëŠ”ì§€ ì¡°ì‚¬, ìˆì„ ê²½ìš° `EmailExistedException` throw ì²˜ë¦¬
- `PasswordEncoder` autowiredë¡œ ë°›ì€ ê°ì²´ë¥¼ ê°€ì§€ê³  íŒ¨ìŠ¤ì›Œë“œ ì•”í˜¸í™” ì§„í–‰

<br>

## ğŸ”– 2. ë¡œê·¸ì¸ / ë¡œê·¸ì•„ì›ƒ ì„œë²„ ì²˜ë¦¬

`POST /session` request ì²˜ë¦¬(login: sessionì„ ìƒì„±í•˜ëŠ” ê²ƒ)

```java
// SessionController.java
    @PostMapping("/session")
    public @ResponseBody String create(HttpServletRequest request,
                  SessionApiRequest resource) {
        HttpSession session = request.getSession();
        UserApiResponse userApiResponse = userService.authenticate(resource.getEmail(), resource.getPassword());

        SessionApiResponse sessionApiResponse = SessionApiResponse.builder()
                .email(userApiResponse.getEmail())
                .account(userApiResponse.getAccount())
                .build();

        session.setAttribute("member", sessionApiResponse);
        session.setMaxInactiveInterval(30 * 60); // 30ë¶„ ìœ íš¨ì‹œê°„

        return "0";
    }
```
- login ê¸°ëŠ¥ì— ëŒ€í•œ ì„œë²„ ì²˜ë¦¬
- sessionì„ ë¶ˆëŸ¬ì™€ ê±°ê¸°ì— member ì •ë³´(account, email)ë¥¼ ë„£ëŠ”ë‹¤.
- 30ë¶„ ìœ íš¨ê¸°ê°„ ì„¤ì •(default)
- ì„±ê³µí•˜ë©´ 0ì„ ë°˜í™˜í•˜ë„ë¡ @ResponseBody ì„¤ì •


```java
// SecurityJavaConfig.java
@Configuration
@EnableWebSecurity
public class SecurityJavaConfig extends WebSecurityConfigurerAdapter {

    @Override
    protected void configure(HttpSecurity http) throws Exception {
        http
                .cors().disable()
                .csrf().disable()
                .formLogin().disable()
                .logout()
                    .logoutSuccessUrl("/home")
                    .invalidateHttpSession(true)
                    .deleteCookies("JSESSIONID")
                    .and()
                .headers().frameOptions().disable();
    }

    @Bean
    public PasswordEncoder passwordEncoder() {
        return new BCryptPasswordEncoder();
    }
}
```
- Spring Securityì— ëŒ€í•œ ì„¤ì •íŒŒì¼
- logout ê¸°ëŠ¥ í™œì„±í™”ë¥¼ í†µí•´ logout ì„±ê³µì‹œ ë‚´ë³´ë‚¼ url ì„¤ì •, Session ì •ë³´ ì‚­ì œ, Cookieì— ìˆëŠ” Session ID ì‚­ì œ
- ì´ë ‡ê²Œ í•˜ë©´ defaultë¡œ ì„¤ì •ë˜ì–´ ìˆëŠ” /logout urlë¡œ ìš”ì²­í•  ì‹œ Security ì„¤ì •ì— ë”°ë¼ ìë™ìœ¼ë¡œ ì„¸ì…˜ ì§€ìš°ê³  /homeìœ¼ë¡œ ì´ë™í•œë‹¤.