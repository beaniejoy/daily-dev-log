> - 200427 dev log
> - cagong-ranking-project  
> - spring-boot, MySQL, IntelliJ  

<br>

## ğŸ”– 1. ajax ì—°ë™(jQuery)

```js
$.ajax({
    type : 'GET',
    url : '/cafes/scoresets?index=' + category,
    dataType : 'json',
    error : function() {
        alert('error');
    },
    success : function(data) {
        // data ì´ìš©
    }
}
```
- jQueryë¥¼ ì´ìš©í•œ ajaxë„˜ê¸°ëŠ” ë°©ì‹(GET Method)
- `/cafes/scoresets`ë¼ëŠ” urlì„ í†µí•´ `ScoreSetController`ì— ì§€ì •í•œ methodê°€ í˜¸ì¶œëœë‹¤.

```java
// ScoreSetController.java
    @GetMapping("/cafes/scoresets")
    public List<ScoreSetApiResponse> getScoreSets(@RequestParam("index") String category) {
        return scoresService.getScoreSets(category);
    }
```
- `index`ë¼ëŠ” parameterë¥¼ ë„˜ê²¼ê¸° ë•Œë¬¸ì— `@RequestParam`ì„ í†µí•´ ë°›ì•„ì˜¨ë‹¤.


```java
// ScoreSetService.java
public List<ScoreSetApiResponse> getScoreSets(String category) {
        List<ScoreSet> scoreSetList = new ArrayList<>();

        switch (category) {
            case "mood": scoreSetList = scoreSetRepository.findTop5ByOrderByMoodDesc(); break;
            case "light": scoreSetList = scoreSetRepository.findTop5ByOrderByLightDesc(); break;
            case "price": scoreSetList = scoreSetRepository.findTop5ByOrderByPriceDesc(); break;
            case "taste": scoreSetList = scoreSetRepository.findTop5ByOrderByTasteDesc(); break;
            default: break;
        }

        return scoreSetList.stream()
                .map(this::response)
                .map(scoreSetApiResponse -> {
                    Cafe cafe = cafeRepository.findById(scoreSetApiResponse.getCafeId())
                            .orElseThrow(() -> new CafeNotFoundException(scoreSetApiResponse.getCafeId()));

                    scoreSetApiResponse.setCafeName(cafe.getName());
                    scoreSetApiResponse.setCafeImgUrl(cafe.getImgUrl());

                    return scoreSetApiResponse;
                })
                .collect(Collectors.toList());
    }

    // TODO: Optional ì–´ë–»ê²Œ ì²˜ë¦¬í•  ê²ƒì¸ì§€ ì•Œì•„ë³´ì
    public ScoreSet getScoreSetByCafeId(Long cafeId) {
        return scoreSetRepository.findByCafeId(cafeId).
                orElseThrow(() -> new ScoreSetNotFoundException(cafeId));
    }
```
- `findTop5ByOrderByMoodDesc`ë¥¼ Repositoryì— ì„¤ì •, findTop5By[ê¸°ì¤€] í˜•ì‹ìœ¼ë¡œ í•˜ë©´ selectëœ table ìƒìœ„ 5ê°œë¥¼ ë½‘ì•„ì¤€ë‹¤.
- OrderByMoodDescëŠ” mood ì¹¼ëŸ¼ ê¸°ì¤€ìœ¼ë¡œ ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬ì„ í•´ì¤€ë‹¤. `ORDER BY mood DESC` queryë¬¸ê³¼ ê°™ë‹¤.
- ê·¸ë ‡ê²Œ ë½‘ì•„ì˜¨ 5ê°œì˜ Listê°ì²´ì— streamì„ ì´ìš©í•´ Responseê°ì²´ ì•ˆì— cafeName, cafeImgUrlì„ ë„£ì–´ì¤€ë‹¤. ê·¸ë˜ì•¼ frontì—ì„œ ì‘ì—… ê°€ëŠ¥

<br>

## ğŸ”– 2. search pageì—ì„œ ì£¼ì˜í•  ì 
```html
<a th:href="@{/cafes/search(phrase=${phrase}, page=*{currentPage - 1})}"></a>
```
- parameterë¥¼ phraseì™€ page ë‘ê°œë¥¼ ë°˜ë“œì‹œ ë„˜ê²¨ì•¼ í•œë‹¤.
- í•˜ë‚˜ë¼ë„ ë¹ ì§€ë©´ controllerë‚´ì˜ business logicì— ì—ëŸ¬ê°€ ë°œìƒí•œë‹¤.

<br>

## ğŸ”– 3. form tagë¥¼ í†µí•´ searchí•˜ê¸°

```html
 <form class="form-inline" method="get" th:action="@{/cafes/search}">
    <input class="form-control mr-sm-2" type="text" 
            placeholder="ì¹´í˜ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”" id="search" name="phrase"
            aria-label="Search" value="">
    <button class="btn btn-secondary my-2 my-sm-0" type="submit">ì¹´í˜ì°¾ê¸°</button>
</form>
```
- `th:action="@{/cafes/search}"`: ê·¸ëƒ¥ `action`ì†ì„±ìœ¼ë¡œ url ê¸°ì…í•´ë„ ëœë‹¤.
- GET Methodë°©ì‹ìœ¼ë¡œ /cafes/searchì— mappingëœ methodë¥¼ í˜¸ì¶œí•œë‹¤.
- `CafeController`ì—ì„œ ì²˜ë¦¬

```java
// CafeController.java
    @GetMapping("/search")
    public String list(Model model,
                       @RequestParam("phrase") String phrase,
                       @PageableDefault(sort = "id", direction = Sort.Direction.ASC, size = 3) Pageable pageable) {
        model.addAttribute("cafes", cafeService.getCafes(phrase, pageable).get("cafes"));
        model.addAttribute("page", cafeService.getCafes(phrase, pageable).get("page"));
        model.addAttribute("phrase", phrase);
        return "search";
    }
```
- `@RequestParam("phrase") String phrase`: String phraseë¡œ í•´ë„ ì•Œì•„ì„œ parameter nameì´ phraseì˜ valueë¥¼ ê°€ì ¸ì˜¨ë‹¤.
- `phrase`ë¥¼ í†µí•´ cafe nameì— í¬í•¨ëœ ë‹¨ì–´ë‚˜ êµ¬ì ˆì´ ìˆëŠ”ì§€ë„ ê²€ìƒ‰í•´ í•´ë‹¹ë˜ëŠ” ëª¨ë“  Cafe Listë¥¼ ë‚´ë³´ë‚¸ë‹¤.
- paginationê¹Œì§€ ì²˜ë¦¬í•´ì•¼í•˜ë¯€ë¡œ ì´ì— ëŒ€í•œ ë§¤ê°œë³€ìˆ˜ë„ ë°›ì•„ì¤€ë‹¤.

```java
// CafeService.java
    Page<Cafe> cafes = cafeRepositoy.findAllByNameContaining(phrase, pageable);
```
- `findAllByNameContainingì„` í†µí•´ Cafe Entityì˜ name ì¹¼ëŸ¼ì—ì„œ í•´ë‹¹ phraseê°€ í¬í•¨ë˜ì–´ ìˆëŠ”ì§€ì— ë”°ë¼ selectí•´ì¤€ë‹¤.
- Pageableê¹Œì§€ ì¸ìë¡œ ê°™ì´ ë„£ì–´ì£¼ë©´ paginationê¹Œì§€ êµ¬í˜„í•  ìˆ˜ ìˆë‹¤.
