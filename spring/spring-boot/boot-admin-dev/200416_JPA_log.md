# JPA

> - 200416 study log
> - spring-boot, admin
> - MySQL, IntelliJ



## ğŸ”– 1. CRUD Test

### SELECT

### UPDATE
```java
    @Test
    public void update() {
        Optional<User> user = userRepository.findById(2L);

        user.ifPresent(selectUser -> {
            selectUser.setAccount("PPPP");
            selectUser.setUpdatedAt(LocalDateTime.now());
            selectUser.setUpdatedBy("update method()");

            userRepository.save(selectUser);
        });
    }
```
- ê¸°ì¡´ì— idê°€ ìˆëŠ” ê²ƒì— ëŒ€í•´ saveì²˜ë¦¬í•˜ë©´ **JPAì—ì„œëŠ” ì•Œì•„ì„œ updateë¡œ ì²˜ë¦¬í•´ì¤€ë‹¤.**
- ê¸°ì¡´ idì˜ ë°ì´í„°ì— saveë¥¼ í•  ë•Œ í•œ ë²ˆë” selectë¥¼ í†µí•´ í•´ë‹¹ idê°’ì´ ì¡´ì¬í•˜ëŠ”ì§€ ì•Œì•„ë‚¸ë‹¤.

<p><img src="https://user-images.githubusercontent.com/41675375/79413960-64490700-7fe4-11ea-95e2-4d2750046e8e.png" width="900" height="150"></p>

- SELECT ë‘ë²ˆ ì‹¤í–‰ í›„ UPDATE ì§„í–‰

### DELETE

```java
public void delete() {
        Optional<User> user = userRepository.findById(2L);

        user.ifPresent(selectUser -> {
            userRepository.delete(selectUser);
        });

        Optional<User> deleteUser = userRepository.findById(2L);

        if(deleteUser.isPresent()){
            System.out.println("user ì¡´ì¬: " + deleteUser.get());
        } else{
            System.out.println("user ì¡´ì¬ X");
        }
    }
```

<p><img src="https://user-images.githubusercontent.com/41675375/79414525-d706b200-7fe5-11ea-8e9a-e46d941f322f.png" width="900" height="120"></p>

- deleteë„ updateì™€ ë§ˆì°¬ê°€ì§€ë¡œ delete(Object o)ë¥¼ ì‹¤í–‰ í•  ë•Œ selectë¥¼ ë¨¼ì €í•˜ê³  ë°ì´í„°ë¥¼ ì§€ìš´ë‹¤.


## ğŸ”– 2. ManyToOne, OneToMany ì—°ê´€ê´€ê³„ ì„¤ì •

### ERD êµ¬ì¶•
- í•œ ëª…ì˜ Userê°€ ì—¬ëŸ¬ Itemì„ ì£¼ë¬¸í•  ìˆ˜ ìˆë‹¤.
- í•œ Itemì—ëŠ” ì—¬ëŸ¬ Userê°€ ì£¼ë¬¸ì„ í•  ìˆ˜ ìˆë‹¤.
- ì¦‰ item : userëŠ” N : N ê´€ê³„

### ë¬¸ì œë°œìƒ
- `user` tableì— ì—¬ëŸ¬ ê°œì˜ item ë°ì´í„°ë¥¼ ë‹´ì„ ìˆ˜ ìˆë‹¤. ì´ë ‡ê²Œ ë˜ë©´ ì¹¼ëŸ¼ì´ ë¬´ìˆ˜íˆ ë§ì•„ì§€ëŠ” ë¬¸ì œ ë°œìƒ
- `item` tableë„ ë§ˆì°¬ê°€ì§€ë¡œ ë¬´ìˆ˜íˆ ë§ì€ ì¹¼ëŸ¼ ë°œìƒ ê°€ëŠ¥
- ì´ë¥¼ ìœ„í•´ ì¤‘ê°„ order listë¥¼ ë‹´ì•„ë‚´ëŠ” tableì„ ë§Œë“¤ì–´ ì¤‘ê°œí•˜ëŠ” ë°©ì‹ìœ¼ë¡œ ERDë¥¼ êµ¬ì„±í•œë‹¤.

<p><img src="https://user-images.githubusercontent.com/41675375/79427518-c9f6bc80-7fff-11ea-8280-3ea07b054bf3.png" width="700" height="250"></p>

- `user` : `order_detail` = 1 : N
- `item` : `order_detail` = 1 : N

```java
// OrderDetail Entity
@Entity
@Data
@NoArgsConstructor
@AllArgsConstructor
@ToString(exclude = {"user", "item"}) // Testì‹œ StackOverFlow ì—ëŸ¬ ë°œìƒ ë°©ì§€
public class OrderDetail {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    private LocalDateTime orderAt;

    // N : 1 (this : User)
    @ManyToOne
    private User user;

    // N : 1 (this : Item)
    @ManyToOne
    private Item item;
}
```
```java
// Item Entity

    // 1 : N (this: OrderDetail)
    @OneToMany(fetch = FetchType.LAZY, mappedBy = "item")
    private List<OrderDetail> orderDetailList;
```
`Item` Entityì— ìœ„ì˜ ë°©ì‹ìœ¼ë¡œ OneToManyë¥¼ ì´ìš©í•´ `OrderDetail`ì˜ Listë¥¼ ë°›ì•„ì˜¨ë‹¤.
```java
// User Entity

    // 1 : N (this: OrderDetail)
    @OneToMany(fetch = FetchType.LAZY, mappedBy = "user")
    public List<OrderDetail> orderDetailList;
```
`User` Entityë„ ë§ˆì°¬ê°€ì§€ë‹¤.

### Test ì§„í–‰
```java
// UserRepositoyTests.java

    @Test
    @Transactional
    public void read() {
        // select * from user where id = ?
        Optional<User> user = userRepository.findById(1L);

        user.ifPresent(selectUser -> {
            selectUser.getOrderDetailList().stream().forEach(detail -> {
                Item item = detail.getItem();
                System.out.println(item);
            });
        });
    }
```
ìœ„ ë°©ì‹ìœ¼ë¡œ Testë¥¼ ì§„í–‰í•˜ë©´ `findById(1L)`ë¡œ ì°¾ì€ Userì˜ ì£¼ë¬¸ë¦¬ìŠ¤íŠ¸ë¥¼ ì¶œë ¥í•  ìˆ˜ ìˆë‹¤.
```bash
Item(id=1, name=ë…¸íŠ¸ë¶, price=100000, content=ì‚¼ì„± ë…¸íŠ¸ë¶, orderDetailList=[OrderDetail(id=1, orderAt=2020-04-16T15:12:05)])
```

## ğŸ”– 3. QueryMethod

```java
@Repository
public interface UserRepository extends JpaRepository<User, Long> {

    // select * from user where account = ?
    Optional<User> findByAccount(String account);

    // select * from user where email = ?
    Optional<User> findByEmail(String email);

    // select * from user where account = ? and email = ?
    Optional<User> findByAccountAndEmail(String account, String email);
}
```

## ğŸ”– 4. FetchType - Lazy, EAGER

### LAZY
- ì§€ì—°ë¡œë”©
- ì¡°ê±´ì ˆì˜ idì— ëŒ€í•´ì„œë§Œ findí•œë‹¤.
```sql
SELECT * FROM item WHERE id =?
```
- ì—°ê´€ê´€ê³„ê°€ ì„¤ì •ëœ tableì— ëŒ€í•´ì„œ selectì„ í•˜ì§€ ì•Šê² ë‹¤.
- ì—°ê´€ê´€ê³„ ì„¤ì •ì— ëŒ€í•œ ì¶”ì²œ type

### EAGER
- ì§€ì—°ë¡œë”©
```sql
    item_id = order_detail.item_id
    user_id = order_detail.user_id
    where item.id = ?
```
- ì—°ê´€ê´€ê³„ê°€ ì„¤ì •ëœ ëª¨ë“  tableì— ëŒ€í•´ì„œ joinì´ ë°œìƒí•œë‹¤.
- ëª¨ë“  ë°ì´í„°ë¥¼ joiní•´ì„œ ë‹¤ ê°€ì ¸ì˜¤ê¸°ì— ì„±ëŠ¥ì˜ ì €í•˜ê°€ ë°œìƒí•˜ê±°ë‚˜, ê°€ì ¸ì˜¤ì§€ ëª»í•˜ëŠ” ë¦¬ìŠ¤í¬ ë°œìƒ
- 1 : 1 (`OneToOne`) ê´€ê³„ì¼ ë•Œ ì‚¬ìš©